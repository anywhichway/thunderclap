# thunderclap

Thunderclap is an indexed JSON database and function server designed specifically for Cloudflare. It runs on top of the
Cloudflare KV store. Its query language, [JOQULAR](https://medium.com/@anywhichway/joqular-high-powered-javascript-pattern-matching-273a0d77eab5) 
(JavaScript Object Query Language), is similar to, but more extensive than, the query language associated with MongoDB. 
In addition to having more predicates than MongoDB, JOQULAR extends pattern matching to object properties, e.g.

```javascript
{[/a.*/]:{$eq: 1}} // match all objects with properties starting with the letter "a" containing the value 1
```

Thunderclap also supports:

1) role based access control mechanisms

2) schema or schemaless operation

3) triggers

4) inline analytics and hooks

5) full text indexing and search

6) custom functions (with access control).

Like MongoDB, Thunderclap is open-sourced under the Server Side Public License. This means licencees are free to use and 
modify the code for internal applications or public applications that are not primarily a means of providing Thunderclap
as a hosted service. In order to provide Thunderclap as a hosted service you must either secure a commercial license from 
AnyWhichWay or make all your source code available, including the source of non-derivative works that support the 
monitoring and operation of Thunderclap as a service.

# Important Notes

Thunderclap is currently in ALPHA because:

1) Workers KV from Cloudflare recently came out of beta and is missing a few key features that are "patched" by 
Thunderclap.

2) Security measures are incomplete and have not yet been vetted by a third party

3) Although there are many unit tests, application level functional testing has been limited

4) The source code could do with a lot more comments

5) Project structure does not currently have a clean separation between what people might want to change
for their own use vs submit as a pull request. In general, changes to file in the `src` directory are
candidates for pull requests and with the exception of this README those outside are not.

6) It has not been performance tuned.

7) It could do with contributors!

## Installation and Deployment

Clone the repository https://www.github.com/anywhichway/thunderclap.

Run `npm install`.

### Production

NOTE: While the software is in ALPHA state, you should probably not deploy to a production Cloudflare server that
is not behind Cloudflare's paid Access management interface.

When Thunderclap is running in production, it will be available at `thunderclap.<your-domain>`. When it is running in 
development mode, it will be available at `<dev-host-prefix>-thunderclap.<your-domain>`.

You can deploy and use Thunderclap immediately after creating and populating a `thunderclap.json` configuration file
and establishing a CNAME alias `thunderclap` in the Cloudflare DNS control panel. This can just point to your root, 
you do not need a distinct IP address, Cloudflare's smart routers will send requests to the Thunderclap workers.

Create a Cloudflare Workers KV namespace using the Cloudflare Workers control panel. By convention the following 
name form is recommended so that the name parallels the name of thw worker script generated by Thunderclap.

`thunderclap-<primaryHostName>-<com|org|...>`

e.g. `thunderclap-mydomain-com` is the KV namespace and script name associated with `thunderclap.mydomain.com`

You will need to populate a file `thunderclap.json` with many of your Cloudflare ids or keys. Copy the file 
`thunderclap.template.json` to `thunderclap.json` and replace the placeholder values. This will contain secret keys,
so you may want to move it out of your project directory to avoid having it checked-in. The `thunderclap` script in
`webpack.config.js` assumes the file is up one level in the directory tree. If you do leave it in the project
directory it will still be found, but .gitignore is configured to not check it in. .gitignore is also set to ignore 
`dbo.js`, which contains the default `dbo` password and `keys.js` which contains a function definition for iterating
over keys on the server that requires special credentials. None of this data is built into the browser software.

You will need to edit `webpack.config.js` if you wish to put `thunderclap.json` elsewhere or load keys from 
environment variables.

You will need to place the file `db.json` at the root of your web server's public directory and `thunderclap.js` 
in your normal JavaScript resources directory. For convenience, `db.json` and `thunderclap.js` are located in the `docs` 
subdirectory of the repository so you can host them using GitHub Pages if you wish.

You can use Thunderclap without making any modifications by setting the `mode` in `thunderclap.json` to `production`
and running `npm run thunderclap`. This will deploy the Thunderclap worker and a route.

See the files in `docs` and `docs/test` for examples of using Thunderclap.

### Development

If you wish to modify Thunderclap, you must subscribe to the Cloudflare Argo tunneling service on the domain where 
you wish to use Thunderclap.

Create a Cloudflare Workers KV namespace using the Cloudflare Workders control panel. By convention the following 
name form is recommended so that the name parrallels the name of the worker script generated by the Thunderclap script 
`npm run thunderclap`.

`<devHost>-thunderclap-<primaryHostName>-<com|org|...>`

e.g. `myname-thunderclap-mydomain-com` is the KV namespace and script name associated with `myname-thunderclap.mydomain.com`

You do not need a CNAME record for your dev host, Argo manages this for you.

If the 'mode' in 'thunderclap.json` is set to `development`, then in addition to deploying the worker script to
`<devHost>-thunderclap-<primaryHostName>-<com|org|...>` with a route, a local web server is started with an Argo tunnel 
to access `<dev-host-prefix>-thunderclap.<your-domain>` via your web browser.

If you access `https://<dev-host-prefix>-thunderclap.<your-domain>/test/` via your web browser, the unit test file 
will load. 

There is a primitive UI for making one-off requests at `https://<dev-host-prefix>-thunderclap.<your-domain>/thunderclap.html`.

When in dev mode, files are watched by webpack and any changes cause a re-bundling and deployment of the worker script
to Cloudflare.

# Data Manipulation

Data in Thunderclap can be manipulated using a JavaScript client or CURL.

Unlike most JSON data stores, Thuderclap supports the storage of Infinity, -Infinity, and NaN. Dates are automatically 
serialized and de-serialized.

## JavaScript Client

```javascript
<script src="thunderclap.js"></script>
<script>
const endpoint = "https://thunderclap.mydomain.com/db.json",
	username = "<get from somewhere>",
	password = "<get from somewhere>",
	db = new Thunderclap({endpoint,user:{username,password}});
</script>
```

`undefined async clear(string prefix="")` - Deletes items whose keys start with `prefix`. By default it can only be 
called by a user with the `dbo` role.

`string async changePassword(string userName,string password,string oldPassword)` - Changes the password from
`oldPassword` to `password` for the user with name `userName` and old password `oldPassword`. If `password` is not 
provided, a random 10 character password is generated. If the currently authenticated user has the role `dbo` and 
is not the user for whom the password wis being changed, `oldPassword` can be omitted.

`User async createUser(string userName,string password,reAuth)` - creates a user. The password is stored on the server
as an SHA-256 hash and salt. `createUser` can be called even if Thunderclap is started without a username and password. 
If this is done and `createUser` succeeds, the Thunderclap instance is bound to the new user for immediate authenticated 
use. If `reAuth` is truthy, the Thunderclap instance will also be re-bound to the new user. You can implement access 
control and account creation logic on the server to prevent the creation of un-authorized accounts. See the section 
Security.

`Array async entries(string prefix="",{number batchSize,string cursor})` - Returns an array or arrays for keys,
values and expirations of of data with keys that start with `prifix`., e.g. `entries("Person@")` might return:

```
[["Person@jxmc9cc1kswqak4ga",{"name":"joe"},1562147669820],["Person@jxmcnqkx9irjhrz4p",{"name":"joe"},1562147669820]]
```

It can be used in a loop just like `keys` below.

`any async getItem(string key)` - Gets the value at `key`. Returns `undefined` if no value exists.

`boolean async hasKey(string key)` - Returns `true` is `key` exists.

`Array async keys(prefix="",{number batchSize,string cursor,boolean expanded})` - Returns an Array of the next `batchSize`
keys in database than match the `prefix` every time it is called. By default it can only be called by a user with the 
`dbo` role. You can use a loop to process all keys:

```
	let cursor;
	do {
		keys = await mythunder.keys("",{cursor});
		cursor = keys.pop();
		keys.forEach((key) => dosomething(key));
	} while(cursor && keys.length>0)
```

`any async putItem(object value,options={})` - Adds a unique id on property "#" if one does not exist, indexes the object and 
stores it with `setItem` using the id as the key. In most cases the unique id will be of the form 
`<className>@xxxxxxxxxxxxx`.

`boolean async removeItem(string|object keyOrObject) - Removes the keyOrObject. If the argument is an indexed object 
or a key that resolves to an indexed object, the key and data are removed from the database so long as the user has 
the appropriate privileges. If the key exists but can't be removed the function returns `false`. If the key does not exist
or removal succeeds, the function returns `true`.

`any async setItem(string key,any value,options={})` - Sets the `key` to `value`. If the `value` is an object it is 
NOT indexed. Options can have one of two members: `{expiration: secondsSinceEpoch}` or `{expirationTtl: secondsFromNow}`.

`Array async values(string prefix="",{number batchSize,string cursor})` - Returns all the data associated with keys that
start with `prefix`. By default it can only be called by a user with the `dbo` role. It can be used in a loop just like `keys` above.

## CURL Requests 

To be written

# Indexes

All properties of objects inserted using `putItem` are indexed. Objects that are just a value to `setItem` are 
not indexed. The index is not partitioned per class, it spans all classes.

At the moment one index is created for each unique property name, regardless of the class on which the property
exists.  Atlthoug not directly accessible as such, this index entry is effectively a nested map of values and 
then object ids with the property and value, e.g.

```javascript
{
	<value1>:
	{
		<objectid1>:true,
		<objectid2>:true,
		...
	}
	<value2>:
	{
		<objectid2>:true,
		...
	}
}
```

The root index node can be accessed via `getItem("!")`. Direct access is restricted to users with the role `dbo`
To get at a property index, just add the property name, e.g. `getItem("!userName")`.
To get at a value index, add a stringfied value, e.g. `getItem("!userName!\"joe64\"")`. Of course, you usually don't
have to do this because the JOQULAR pattern processing engine in the worker script does it for you. Also, only users
with the role `dbo` can directly query indexes.

The physical size limit of a `thunderclap` database is the same as that of Cloudflare KV Store minus the size of 
the index records.

The portion of the 128MB of RAM used for indexes in each Cloudflare KV hosting a `thunderclap` is:

```
  (character size of all the property names + the number of property names)
+ (size of all property values as strings for the property being tested at any given moment)
```

Property names are relatively few in practice unless the names themselves are used for unique values. Let's assume 1,000
at 8 characters each. Except for unique keys, numbers, date/time values, and locations property values also tend to be 
greater in number but still not huge. Let's assume 10,000,000 at 8 characters each.

```
  ((1,000 * 8) + 1,000)
+ (5,000,000 * 8)
= 48MB
```

We have tested an architecture that will reduce the RAM usage and allow for as much storage as physically possible by the
underlying Cloudflare KV store; howvever, it also negatively impacts performance. A final decision on which to use has 
not been made. We may make it configurable.

# Security

The Thunderclap security mechanisms support the application of role based read and write access rules for functions,
objects, properties and storage keys. 

If a user is not authorized read access to an object or key value, it will not be returned. If a user is not 
authorized access to a particular property, the property will be stripped from the object before the
object is returned. Additionaly, a query for an object using properties to which a user does not have access
will automatically drop the properties from the selection process to prevent data leakage through inference.

If a user is not authorized write access to specific properties on an object, update attempts will 
fall back to partial updates on just those properties for which write access is allowed. If write access to a
key or an entire object is not allowed, the write will simply fail and return `undefined`.

At the moment, by default, all keys, objects, and properties are available for read and write unless specifically
controlled in the `acl.js` file in the root of the Thunderclap repository. A future release will support defaulting
to prevent read and write unless specifically permitted.

If the user is not authorized to execute a function a 403 status will be returned.

The default `acl.js` file is show below.

```javacript
(function () {
	module.exports = {
		securedTestReadKey: { // for testing purposes
			read: [] // no reads allowed
		},
		securedTestWriteKey: { // for testing purposes
			write: [] // no writes allowed
		},
		securedTestFunction: { // for testing purposes
			execute: [] // no execution allowed
		},
		[/\!.*/]: { // prevent direct index access by anyone other than a dbo, changing may create a data inference leak
			read: ["dbo"],
			write: ["dbo"]
		},
		clear: { // only dbo can clear
			execute: ["dbo"]
		},
		entries: { // only dbo can list entries
			execute: ["dbo"]
		},
		keys: { // only dbo can list keys
			execute: ["dbo"]
		},
		values: { // only dbo can list values
			execute: ["dbo"]
		},
		"User@": { // key to control, user <cname>@ for classes
			
			// read: ["<role>",...], // array or map of roles to allow read, not specifying means all have read
			// write: {<role>:true}, // array or map of roles to allow write, not specifying means all have write
			// a filter function can also be used
			// action with be "read" or "write", not returning anything will result in denial
			// not specifying a filter function will allow all read and write, unless controlled above
			// a function with the same call signature can also be used as a property value above
			filter: async function({action,user,data,request}) {
				// very restrictive, don't return a user record unless requested by the dbo or data subject
				if(user.roles.dbo || user.userName===data.userName) {
					return data;
				}
			},
			properties: { // only applies to objects
				read: {
					// example of using a function, only dbo's and data subjects can get roles
					roles: ({action,user,object,key,request}) => user.roles.dbo || object.userName===user.userName, 
					hash: ["dbo"], // only dbo's can read passwod hashes
					salt: {
						dbo: true // example of alternate control form, only dbo's can read password salts
					}
				},
				write: {
					password: {
						// a propery named password can never be written
					},
					// only the dbo and data subject can write a hash and salt
					hash: ({action,user,object,key,request}) => user.roles.dbo || object.userName===user.userName,
					salt: ({action,user,object,key,request}) => user.roles.dbo || object.userName===user.userName,
					//userName: ({action,user,object,key,request}) => object.userName!=="dbo" // can't change name of primary dbo
				},
				filter: async function({action,user,object,key}) {
					return true; // allows all other properties to be read or written, same as having no filter at all
				}
			}
		}
	}
}).call(this);
```

Roles can also be established in a tree that is automatically applied at runtime. See the file `roles.js`.

When Thunderclap is first initialized, a special user `User@dbo` with the user name `dbo` the role `dbo` and the
dbo password defined in `thunderclap.json` is created. It also has the unique id `User@dbo`.

You can create additional accounts with the `createUser` and change passwords with the `changePassword` 
methods documented above.


# Schema

To be written.

# Triggers

Triggers can get invoked before and after key value or indexed object properties change or get deleted. The triggers are configure in 
the file `triggers.js`. Any asynchronous triggers will be awaited. `before` triggers must return truthy for execution to
continue, i.e. a before on set that returns false with result in the set aborting. `before` triggers are fired immediately
before security checks. Triggers are not access controlled.

Triggers can be executed in the browser, a service worker, or the cloud.

```javascript
(function() {
	module.exports = {
		browser: {
		
		},
		cloud: {
			"<keyOrRegExp>": {
				before: { // user and request are frozen, data can be modified
					put({user,data,request}) {
						// if data is an object, it can be modified
						// if a value other than undefined is returned, it will replace the data
						return true;
					},
					remove({user,data,request}) {
						
						return true;
					}
				},
				after: { // will not be awaited, called via setTimeout
					put({user,data,request}) {
						// might send e-mail
						// call a webhook, etc.
						
					},
					remove({user,data,request}) {
						
					}
				}
			},
			"<className>@": {
				before: { // user and request are frozen, data can be modified
					put({user,object,request}) {
						// can modify the object
						// if a value other than undefined is returned, it will replace the object
						return true;
					},
					update({user,object,property,value,oldValue,request}) {
						
						return true;
					},
					remove({user,object,request}) {
						
						return true;
					}
				},
				after: { // will not be awaited, called via setTimeout
					put({user,object,request}) {
						// might send e-mail
						// call a webhook, etc.
					},
					update({user,object,property,value,oldValue,request}) {
						
					},
					remove({user,object,request}) {
						
					}
				}
			}
		},
		worker: {
		
		}
	}
}).call(this);
```
# Inline Analytics & Hooks

Inline analytics and hooks are facilitated by the use of JOQULAR patterns and tranform or hook calls in the file `when.js`.
The transforms and hooks can be invoked from the browser, a service worker, or in the cloud; they are not currently access
controlled. Below is an example.

```javascript
(function() {
	module.exports = {
		browser: [
			{
				when: {testWhenBrowser:{$eq:true}},
				transform: async (data,pattern) => {
					Object.keys(data).forEach((key) => { if(!pattern[key]) delete data[key]; });
					return data;
				},
				call: async (data,pattern) => {
					
				}
			}
		],
		cloud: [
			{
				when: {testWhen:{$eq:true}},
				transform: async (data,pattern) => {
					Object.keys(data).forEach((key) => { if(!pattern[key]) delete data[key]; });
					return data;
				},
				call: async (data,pattern) => {
					
				}
			}
		],
		worker: [
			
		]
	}
}).call(this);

```

# Functions

Exposing server functions to the JavaScript client in the browser is simple. Just define the functions in 
the file `functions.js`. Any asynchronous functions will be awaited.

```javascript
(function() {
	module.exports = {
		securedTestFunction() {
			return "If you see this, there may be a security leak";
		},
		getDate() {
			return new Date();
		}
	}
}).call(this);
```

The functions will automatically become available in the admin client `docs/thunderclap`. Function execution can
be access controlled in `acl.js`.

# History and Roadmap

Many of the concepts in Thunderclap were first explored in ReasonDB. ReasonDB development has been suspended for now, 
but many features found in ReasonDB will make their way into Thunderclap if interest is shown in the software. This
includes the addition of graph queries a la GunDB, full-text indexing, and joins.

# Change Log (reverse chronological order)

2019-07-04 v0.0.17a Added full text indexing with `{$search: string terms}` or `{$search: [string terms, number pctMatch]}`

2019-07-03 v0.0.16a Added `changePassword(userName,password,oldPassword)`.

2019-07-02 v0.0.15a Added `clear(prefix)`, `entries(prefix,options)`, `hasKey(key)`, `values(prefix,options)`.
All are limited to dbo access. Reverted to two level index for now to address performance. Limits number of 
entries per index due to 128MB limit of Cloudflare Workers.

2019-06-30 v0.0.14a Ehanced triggers and functions to allow browser, service worker, or cloud execution. 
Added `when` capability. Service worker support will operate once service workers are generated during the
build process.

2019-06-26 v0.0.13a Indexing optimized to reeuce RAM usage. Substantive performance drop.

2019-06-26 v0.0.12a Indexing now extends to 3 levels to provide more data spread. Sub-objects still not 
indexed as direct paths. Added support for expiring keys and listing keys.

2019-06-25 v0.0.11a Code optimizations and bug fixes.

2019-06-24 v0.0.10a Custom function support added.

2019-06-22 v0.0.9a Triggers on put, update, remove.

2019-06-22 v0.0.8a Triggers now working for `putItem`.

2019-06-22 v0.0.7a Added JOQULAR pattern `$near:[target,range]`. Range can be a number, in which case it is 
added/substracted or a string ending in the `%` sign, in which case the percentage is add/substracted. Added 
stress tests up to 1000 items. Started support for RegExp as acl keys. Enhanced doucmentation.

2019-06-21 v0.0.6a Documentation improvements.

2019-06-21 v0.0.5a ACL improvements. More of unit tests.

2019-06-20 v0.0.4a Added a large number of unit tests


